apiVersion: apps/v1
kind: Deployment
metadata:
  name: mas
  namespace: matrix
  annotations:
    reloader.stakater.com/auto: "true"
spec:
  progressDeadlineSeconds: 600
  replicas: 1
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      k8s-app: mas
  strategy:
    type: Recreate
  template:
    metadata:
      creationTimestamp: null
      labels:
        k8s-app: mas
      name: mas
    spec:
      initContainers:
        - name: cfgsync
          image: ghcr.io/element-hq/matrix-authentication-service:1.11.0
          imagePullPolicy: Always
          args:
            - config
            - sync
          env:
            - name: MAS_CONFIG
              value: /config/config.yaml
            - name: MAS_database.uri
              valueFrom:
                secretKeyRef:
                  name: pg-mas-app
                  key: uri
          volumeMounts:
            - mountPath: /config
              name: mas-cfg
            - mountPath: /config/keys
              name: mas-keys
      containers:
        - name: mas
          image: ghcr.io/element-hq/matrix-authentication-service:1.11.0
          imagePullPolicy: Always
          args:
            - server
          env:
            - name: MAS_CONFIG
              value: /config/config.yaml
            - name: MAS_database.uri
              valueFrom:
                secretKeyRef:
                  name: pg-mas-app
                  key: uri
          ports:
            - containerPort: 8080
              name: http
          volumeMounts:
            - mountPath: /config
              name: mas-cfg
            - mountPath: /config/keys
              name: mas-keys
      dnsPolicy: ClusterFirst
      restartPolicy: Always
      schedulerName: default-scheduler
      terminationGracePeriodSeconds: 10
      volumes:
        - name: mas-cfg
          projected:
            sources:
              - configMap:
                  name: mas
                  items:
                    - key: config.yaml
                      path: config.yaml
              - secret:
                  name: mas
                  items:
                    - key: encryption
                      path: encryption_file
                    - key: hs_token
                      path: hs_token
                    - key: keycloak-client-secret
                      path: keycloak-client-secret

        - name: mas-keys
          secret:
            secretName: mas-keys
